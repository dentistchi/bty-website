/**
 * Anti-exploit rules for emotional stats — pure / simple rules only.
 * duplicate_pattern_penalty, rapid_session_penalty, emotion_spam_no_reward, deep_trauma_not_bonus_scored.
 * Single source: docs/SYSTEM_UPGRADE_PLAN_EMOTIONAL_STATS.md §1.6, healing-coaching-spec-v3 anti_exploit.
 */

import type { EmotionalEventId } from "./coreStats";

export interface SessionContext {
  /** Event IDs in this session (in order). */
  eventIdsInSession: EmotionalEventId[];
  /** Timestamp of last session end (ms), or null. */
  lastSessionEndedAt: number | null;
  /** Current session start (ms). */
  sessionStartedAt: number;
  /** Rapid session window minutes (same window = same "session" for penalty). */
  rapidWindowMinutes?: number;
  /** Max same event type in a row before novelty penalty. */
  duplicatePatternThreshold?: number;
}

const DEFAULT_RAPID_WINDOW_MINUTES = 10;
const DEFAULT_DUPLICATE_THRESHOLD = 3;

/**
 * Whether to apply reward for this session (MVP: simple rules).
 * false = do not record / do not add stat gain.
 */
export function shouldApplyReward(context: SessionContext): boolean {
  if (context.eventIdsInSession.length === 0) return false;

  if (hasRapidSessionPenalty(context)) return false;
  if (hasDuplicatePatternPenalty(context)) return false;
  return true;
}

/**
 * rapid_session_penalty (v3 anti_exploit): last session ended within window_minutes → no reward.
 * Spec window_minutes: 10; spec multiplier: 0.6 — 구현은 보수적으로 10분 이내 시 보상 없음.
 */
function hasRapidSessionPenalty(context: SessionContext): boolean {
  const last = context.lastSessionEndedAt;
  if (last == null) return false;
  const windowMs = (context.rapidWindowMinutes ?? DEFAULT_RAPID_WINDOW_MINUTES) * 60 * 1000;
  const elapsed = context.sessionStartedAt - last;
  return elapsed < windowMs;
}

/**
 * duplicate_pattern_penalty: same event type repeated too many times in session → no reward.
 * MVP: if same event appears >= threshold times in a row (or total in session), deny.
 */
function hasDuplicatePatternPenalty(context: SessionContext): boolean {
  const threshold = context.duplicatePatternThreshold ?? DEFAULT_DUPLICATE_THRESHOLD;
  const ids = context.eventIdsInSession;
  let maxInRow = 0;
  let cur = 0;
  let prev: EmotionalEventId | null = null;
  for (const id of ids) {
    if (id === prev) {
      cur++;
    } else {
      cur = 1;
      prev = id;
    }
    maxInRow = Math.max(maxInRow, cur);
  }
  return maxInRow >= threshold;
}

/**
 * Novelty factor [0.2, 1.0]: same pattern repeated → decrease.
 * Pure function for use in formula.
 */
export function computeNovelty(eventIdsInSession: EmotionalEventId[]): number {
  if (eventIdsInSession.length === 0) return 1;
  const unique = new Set(eventIdsInSession).size;
  const total = eventIdsInSession.length;
  const ratio = unique / total;
  return Math.max(0.2, Math.min(1, 0.2 + ratio * 0.8));
}

/**
 * Consistency factor [1.0, 1.4]: 7-day activity → increase (v3 consistency.range).
 * Pure function; caller passes in activityDaysLast7 (from DB/service).
 */
export function computeConsistency(activityDaysLast7: number): number {
  if (activityDaysLast7 <= 0) return 1;
  return Math.min(1.4, 1 + (activityDaysLast7 - 1) * 0.05);
}
